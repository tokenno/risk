<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map Application</title>
  <!-- Leaflet CSS with corrected integrity hash -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin="" />
  <!-- Vue.js production build -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    #map {
      height: 400px;
      width: 100%;
      border: 1px solid #ccc;
    }
    .map-container {
      position: relative;
      height: 400px;
      width: 100%;
      margin-bottom: 20px;
    }
    .error-message, .retry-button {
      text-align: center;
      margin: 10px 0;
    }
    .error-message p {
      color: #d32f2f;
      font-weight: bold;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background-color: #0056b3;
    }
    .status-container, .nearby-users {
      margin-top: 20px;
    }
    .status-container p {
      margin: 5px 0;
    }
    .nearby-users h3 {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div v-if="initializing">
      <p>Initializing application...</p>
    </div>

    <div v-if="authError" class="error-message">
      <p>Authentication Error</p>
      <p>Unable to authenticate. Please try again.</p>
      <button class="retry-button" @click="retryAuth">Retry</button>
    </div>

    <div v-if="mapError" class="error-message">
      <p>Map Error</p>
      <p>{{ mapErrorMessage }}</p>
      <button class="retry-button" @click="retryMap">Retry</button>
    </div>
    <div v-else class="map-container">
      <div id="map"></div>
    </div>

    <div v-if="locationError" class="error-message">
      <p>Location Error</p>
      <p>{{ locationErrorMessage }}</p>
      <button class="retry-button" @click="retryLocation">Retry</button>
    </div>

    <div class="status-container">
      <div>
        <p>Status: <span>{{ status }}</span></p>
        <p>User: <span>{{ user }}</span></p>
      </div>
      <div>
        <button @click="goOnline">{{ status === 'ONLINE' ? 'Go Offline' : 'Go Online' }}</button>
        <button @click="setName">Set Name</button>
      </div>
      <button @click="refreshLocation">Refresh Location</button>
    </div>

    <div class="nearby-users">
      <h3>Nearby Users (1km)</h3>
      <p v-if="loadingNearby">Loading nearby users...</p>
      <ul v-else>
        <li v-for="nearbyUser in nearbyUsers" :key="nearbyUser.id">
          {{ nearbyUser.name }} ({{ nearbyUser.distance }}m)
        </li>
      </ul>
    </div>
  </div>

  <!-- Leaflet JS with corrected integrity hash -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          initializing: true,
          authError: false,
          mapError: false,
          mapErrorMessage: 'Failed to load map. Please check your connection.',
          locationError: false,
          locationErrorMessage: 'Unable to retrieve location.',
          status: 'OFFLINE',
          user: 'loading...',
          map: null,
          userLocation: null,
          loadingNearby: true,
          nearbyUsers: [],
        };
      },
      mounted() {
        // Ensure Leaflet is loaded before initializing
        if (typeof L === 'undefined') {
          console.error('Leaflet not loaded');
          this.mapError = true;
          this.mapErrorMessage = 'Failed to load map library. Please check your connection.';
          this.initializeApp();
          return;
        }
        this.initializeApp();
      },
      methods: {
        async initializeApp() {
          try {
            setTimeout(() => {
              this.initializing = false;
              this.user = 'Anonymous';
              this.initMap();
              this.getUserLocation();
              this.loadNearbyUsers();
            }, 1000);
          } catch (error) {
            console.error('App initialization failed:', error);
            this.authError = true;
          }
        },
        initMap() {
          if (!document.getElementById('map')) {
            console.error('Map container not found');
            this.mapError = true;
            this.mapErrorMessage = 'Map container not found.';
            return;
          }

          if (typeof L === 'undefined') {
            console.error('Leaflet not loaded');
            this.mapError = true;
            this.mapErrorMessage = 'Failed to load map library. Please check your connection.';
            return;
          }

          try {
            this.map = L.map('map').setView([51.505, -0.09], 13); // Default: London
            const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
              maxZoom: 19,
            });

            tileLayer.on('tileerror', (error) => {
              console.error('Tile loading error:', error);
              this.mapError = true;
              this.mapErrorMessage = 'Failed to load map tiles. Please check your connection.';
              L.tileLayer('https://tile.openstreetmap.de/{z}/{x}/{y}.png', {
                attribution: '© <a href="https://www.openstreetmap.de/copyright">OpenStreetMap</a>',
                maxZoom: 19,
              }).addTo(this.map);
            });

            tileLayer.addTo(this.map);
            this.mapError = false;

            setTimeout(() => {
              if (this.map) {
                this.map.invalidateSize();
              }
            }, 100);
          } catch (error) {
            console.error('Map initialization failed:', error);
            this.mapError = true;
            this.mapErrorMessage = 'Map initialization failed: ' + error.message;
          }
        },
        getUserLocation() {
          if (!navigator.geolocation) {
            console.error('Geolocation not supported by this browser.');
            this.locationError = true;
            this.locationErrorMessage = 'Geolocation is not supported by your browser.';
            return;
          }

          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              this.userLocation = [latitude, longitude];
              this.locationError = false;
              this.locationErrorMessage = '';
              if (this.map) {
                this.map.setView(this.userLocation, 15);
                L.marker(this.userLocation)
                  .addTo(this.map)
                  .bindPopup('You are here')
                  .openPopup();
                this.map.invalidateSize();
              }
            },
            (error) => {
              console.error('Geolocation error:', error.message, error.code);
              this.locationError = true;
              switch (error.code) {
                case error.PERMISSION_DENIED:
                  this.locationErrorMessage = 'Location access denied. Please enable location permissions.';
                  break;
                case error.POSITION_UNAVAILABLE:
                  this.locationErrorMessage = 'Location information is unavailable. Please try again.';
                  break;
                case error.TIMEOUT:
                  this.locationErrorMessage = 'Location request timed out. Please try again.';
                  break;
                default:
                  this.locationErrorMessage = 'An error occurred while retrieving location.';
              }
            },
            {
              timeout: 10000,
              maximumAge: 0,
              enableHighAccuracy: true,
            }
          );
        },
        retryAuth() {
          this.authError = false;
          this.initializeApp();
        },
        retryMap() {
          this.mapError = false;
          this.mapErrorMessage = 'Failed to load map. Please check your connection.';
          if (this.map) {
            this.map.remove();
          }
          this.initMap();
        },
        retryLocation() {
          this.locationError = false;
          this.locationErrorMessage = 'Unable to retrieve location.';
          this.getUserLocation();
        },
        goOnline() {
          this.status = this.status === 'ONLINE' ? 'OFFLINE' : 'ONLINE';
        },
        setName() {
          const newName = prompt('Enter your name:') || 'Anonymous';
          this.user = newName;
        },
        refreshLocation() {
          this.getUserLocation();
        },
        async loadNearbyUsers() {
          this.loadingNearby = true;
          setTimeout(() => {
            this.nearbyUsers = [
              { id: 1, name: 'User1', distance: 500 },
              { id: 2, name: 'User2', distance: 750 },
            ];
            this.loadingNearby = false;
          }, 1000);
        }
      }
    }).mount('#app');
  </script>
</body>
</html>