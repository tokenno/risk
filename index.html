
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meet with Sound</title>
  <!-- Leaflet CSS for map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 500px; width: 100%; }
    #status { text-align: center; margin: 10px; }
    #permission-message { text-align: center; color: red; display: none; }
    #retry-button, #beacon-button, #sound-button, #test-sound-button { display: block; margin: 10px auto; padding: 10px; }
    .hidden { display: none; }
    .flashing { animation: flash 1s infinite; }
    @keyframes flash {
      50% { opacity: 0; }
    }
    #gender-select { display: block; margin: 10px auto; padding: 5px; }
    .marker-male { background: blue; border-radius: 50%; width: 12px; height: 12px; }
    .marker-female { background: pink; width: 12px; height: 12px; }
    .marker-nonbinary { background: green; clip-path: polygon(50% 0%, 100% 100%, 0% 100%); width: 12px; height: 12px; }
    .marker-you { background: red; border-radius: 50%; width: 12px; height: 12px; }
  </style>
</head>
<body>
  <div id="status">Getting your location...</div>
  <div id="permission-message">
    <h2>Location Permission Required</h2>
    <p>This app needs your location to work properly.</p>
    <p>Please allow location access in your browser settings.</p>
    <button id="retry-button">Retry Location</button>
  </div>
  <select id="gender-select" class="hidden">
    <option value="male">Male</option>
    <option value="female">Female</option>
    <option value="non-binary">Non-binary</option>
  </select>
  <button id="beacon-button" class="hidden">Beacon OFF</button>
  <button id="sound-button" class="hidden">Sound OFF</button>
  <button id="test-sound-button" class="hidden">Test Sound</button>
  <div id="map"></div>

  <!-- Firebase Modular SDK -->
  <script type="module">
    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getFirestore, collection, doc, setDoc, onSnapshot, GeoPoint } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDC6w15EQdfuBTZHlpvoxmaL5ISEgbFAWY",
      authDomain: "risk-ec382.firebaseapp.com",
      projectId: "risk-ec382",
      storageBucket: "risk-ec382.firebasestorage.app",
      messagingSenderId: "177105151944",
      appId: "1:177105151944:web:758b928eb83ccb894902fd",
      measurementId: "G-2LKEG2N7ZD"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Leaflet JS for map
    import 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';

    // Map setup
    const map = L.map('map').setView([0, 0], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // User variables
    let userPosition = null;
    let userMarker = null;
    let otherUsers = {};
    let beaconOn = false;
    let soundOn = false;
    let audioContext = null;
    let oscillator = null;
    let userId = Math.random().toString(36).substring(2); // Random ID for demo
    let userGender = 'male'; // Default gender

    // DOM elements
    const statusDiv = document.getElementById('status');
    const permissionMessage = document.getElementById('permission-message');
    const retryButton = document.getElementById('retry-button');
    const beaconButton = document.getElementById('beacon-button');
    const soundButton = document.getElementById('sound-button');
    const testSoundButton = document.getElementById('test-sound-button');
    const genderSelect = document.getElementById('gender-select');

    // Function to get marker icon based on gender
    function getMarkerIcon(gender, isUser = false) {
      const className = isUser ? 'marker-you' : `marker-${gender.replace('non-binary', 'nonbinary')}`;
      return L.divIcon({
        className: className,
        iconSize: [12, 12],
        iconAnchor: [6, 6],
        popupAnchor: [0, -6]
      });
    }

    // Request location
    function requestLocation() {
      statusDiv.textContent = 'Getting your location...';
      permissionMessage.style.display = 'none';
      navigator.geolocation.watchPosition(
        position => {
          userPosition = [position.coords.latitude, position.coords.longitude];
          statusDiv.className = 'hidden';
          beaconButton.className = '';
          soundButton.className = '';
          testSoundButton.className = '';
          genderSelect.className = '';
          updateUserLocation();
          if (beaconOn) {
            map.setView(userPosition, 15);
          }
        },
        error => {
          statusDiv.className = 'hidden';
          permissionMessage.style.display = 'block';
          console.error('Location error:', error);
        },
        { enableHighAccuracy: true }
      );
    }

    // Update user location and status in Firebase and on map
    async function updateUserLocation() {
      if (userPosition) {
        // Update Firebase
        await setDoc(doc(db, 'users', userId), {
          location: new GeoPoint(userPosition[0], userPosition[1]),
          beaconOn: beaconOn,
          gender: userGender,
          timestamp: new Date()
        }).catch(error => console.error('Firestore write error:', error));

        // Update or create user marker
        if (userMarker) {
          userMarker.setLatLng(userPosition);
          userMarker.setPopupContent(`You (${userGender})`);
          userMarker.setIcon(getMarkerIcon(userGender, true));
        } else {
          userMarker = L.marker(userPosition, {
            icon: getMarkerIcon(userGender, true),
            className: beaconOn ? 'flashing' : ''
          }).addTo(map).bindPopup(`You (${userGender})`);
        }
        if (beaconOn) {
          userMarker.setIcon(getMarkerIcon(userGender, true));
          map.setView(userPosition, 15);
        }
      }
    }

    // Toggle beacon
    beaconButton.addEventListener('click', () => {
      beaconOn = !beaconOn;
      beaconButton.textContent = `Beacon ${beaconOn ? 'ON' : 'OFF'}`;
      updateUserLocation();
      if (beaconOn && soundOn) {
        startBeep();
      } else {
        stopBeep();
      }
    });

    // Toggle sound
    soundButton.addEventListener('click', () => {
      soundOn = !soundOn;
      soundButton.textContent = `Sound ${soundOn ? 'ON' : 'OFF'}`;
      if (soundOn && beaconOn) {
        startBeep();
      } else {
        stopBeep();
      }
    });

    // Test sound
    testSoundButton.addEventListener('click', () => {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        console.log('AudioContext initialized for test');
      }
      if (audioContext.state === 'suspended') {
        audioContext.resume().then(() => console.log('AudioContext resumed'));
      }
      const testOscillator = audioContext.createOscillator();
      testOscillator.type = 'sine';
      testOscillator.frequency.setValueAtTime(440, audioContext.currentTime);
      testOscillator.connect(audioContext.destination);
      testOscillator.start();
      testOscillator.stop(audioContext.currentTime + 0.5);
      console.log('Test sound played');
    });

    // Update gender
    genderSelect.addEventListener('change', () => {
      userGender = genderSelect.value;
      updateUserLocation();
    });

    // Retry location
    retryButton.addEventListener('click', requestLocation);

    // Web Audio API for beep sound
    function startBeep() {
      if (!audioContext) {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          console.log('AudioContext initialized');
        } catch (error) {
          console.error('AudioContext initialization failed:', error);
          return;
        }
      }
      if (audioContext.state === 'suspended') {
        audioContext.resume().then(() => console.log('AudioContext resumed')).catch(error => console.error('AudioContext resume failed:', error));
      }
      updateBeep();
    }

    function stopBeep() {
      if (oscillator) {
        oscillator.stop();
        oscillator = null;
        console.log('Beep stopped');
      }
    }

    function updateBeep() {
      if (!beaconOn || !soundOn || !audioContext || audioContext.state !== 'running') {
        stopBeep();
        console.log('Beep not started: beaconOn=', beaconOn, 'soundOn=', soundOn, 'audioContext.state=', audioContext?.state);
        return;
      }

      // Find closest user
      let minDistance = Infinity;
      let closestUser = null;
      Object.values(otherUsers).forEach(user => {
        if (user.beaconOn && user.location) {
          const distance = map.distance(userPosition, [user.location.latitude, user.location.longitude]);
          if (distance < minDistance) {
            minDistance = distance;
            closestUser = user;
          }
        }
      });

      // Beep only within 100 meters for testing (revert to 20 later)
      const maxDistance = 100; // 100 meters for easier testing
      const minFrequency = 0.5; // Beeps per second (at 100m)
      const maxFrequency = 5; // Beeps per second (very close)
      let frequency = minDistance <= maxDistance
        ? minFrequency + (maxFrequency - minFrequency) * (1 - minDistance / maxDistance)
        : 0;

      if (frequency > 0) {
        if (!oscillator) {
          try {
            oscillator = audioContext.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            oscillator.connect(audioContext.destination);
            oscillator.start();
            console.log('Beep started, distance:', minDistance.toFixed(2), 'meters');
          } catch (error) {
            console.error('Oscillator creation failed:', error);
            return;
          }
        }
        // Schedule beeps
        oscillator.stop(audioContext.currentTime + 0.1);
        oscillator = audioContext.createOscillator();
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        oscillator.connect(audioContext.destination);
        oscillator.start(audioContext.currentTime);
        setTimeout(updateBeep, 1000 / frequency);
      } else {
        stopBeep();
        console.log('No users within', maxDistance, 'meters');
      }
    }

    // Listen for other users' locations
    onSnapshot(collection(db, 'users'), snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        const id = doc.id;
        if (id === userId) return;

        if (data.beaconOn && data.location) {
          const latlng = [data.location.latitude, data.location.longitude];
          const gender = data.gender || 'unknown';
          if (otherUsers[id]) {
            otherUsers[id].marker.setLatLng(latlng);
            otherUsers[id].marker.setPopupContent(`User (${gender})`);
            otherUsers[id].marker.setIcon(getMarkerIcon(gender));
            otherUsers[id].location = data.location;
            otherUsers[id].beaconOn = data.beaconOn;
          } else {
            otherUsers[id] = {
              marker: L.marker(latlng, {
                icon: getMarkerIcon(gender)
              }).addTo(map).bindPopup(`User (${gender})`),
              location: data.location,
              beaconOn: data.beaconOn
            };
          }
        } else if (otherUsers[id]) {
          map.removeLayer(otherUsers[id].marker);
          delete otherUsers[id];
        }
      });
      if (beaconOn && soundOn) updateBeep();
    }, error => console.error('Firestore snapshot error:', error));

    // Initial location request
    requestLocation();
  </script>
</body>
</html>
