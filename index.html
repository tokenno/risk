<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Index</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/geofire-common@6.0.0/dist/index.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100%;
      overflow-y: auto;
      background: #f5f5f5;
      color: #333;
      -webkit-font-smoothing: antialiased;
    }
    #loading-message {
      text-align: center;
      font-size: 16px;
      margin: 20px;
      color: #666;
      display: block;
    }
    #location-permission-message {
      text-align: center;
      margin: 20px;
      display: none;
    }
    #location-permission-message h2 {
      font-size: 18px;
      color: #d32f2f;
      margin-bottom: 10px;
    }
    #location-permission-message p {
      font-size: 14px;
      color: #666;
      margin: 5px 0;
    }
    #location-permission-message button {
      margin: 10px;
      padding: 8px 16px;
      font-size: 14px;
      color: white;
      background: #1976d2;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #map {
      height: 30vh;
      width: 100%;
      display: block;
    }
    #beacon-button {
      display: none;
      margin: 10px auto;
      padding: 10px 20px;
      font-size: 16px;
      color: white;
      background: #1976d2;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      min-width: 120px;
    }
    #beacon-button:hover {
      background: #1565c0;
    }
    #name-container, #ui-container {
      display: none;
      padding: 5px;
      background: white;
      border-top: 1px solid #ddd;
    }
    #name-input {
      width: 120px;
      padding: 6px;
      margin: 5px auto;
      font-size: 14px;
      display: block;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #set-name-button, #search-button, #send-message, #refresh-button {
      margin: 5px auto;
      padding: 6px 12px;
      font-size: 14px;
      color: white;
      background: #388e3c;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    #search-input, #message-input {
      width: 90%;
      padding: 6px;
      margin: 5px auto;
      font-size: 14px;
      display: block;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #message-list {
      margin: 5px 0;
      max-height: 80px;
      overflow-y: auto;
      font-size: 13px;
    }
    #nearby-users-list, #search-users-list {
      list-style: none;
      padding: 0;
      margin: 5px 0;
    }
    #nearby-users-list li, #search-users-list li {
      margin: 3px 0;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #nearby-users-list li button, #search-users-list li button {
      padding: 4px 8px;
      font-size: 12px;
      background: #0288d1;
      color: white;
      border: none;
      border-radius: 3px;
    }
    h3 {
      font-size: 14px;
      margin: 5px 0;
      color: #444;
    }
    .flashing {
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
    @media (max-width: 600px) {
      #map {
        height: 25vh;
      }
      #beacon-button {
        padding: 8px 16px;
        font-size: 14px;
        min-width: 100px;
      }
      #name-input {
        width: 100px;
        font-size: 13px;
      }
      #search-input, #message-input {
        font-size: 13px;
      }
      #message-list {
        max-height: 60px;
      }
    }
  </style>
</head>
<body>
  <div id="loading-message" style="display: block;">Getting your location...</div>
  <div id="location-permission-message" style="display: none;">
    <h2>Location Permission Required</h2>
    <p>This app needs your location to work properly.</p>
    <p>Please allow location access in your browser settings.</p>
    <button id="retry-location">Retry</button>
    <button id="use-default-location">Use Default Location</button>
  </div>
  <div id="name-container" style="display: none;">
    <input id="name-input" type="text" placeholder="Enter name...">
    <button id="set-name-button">Set Name</button>
  </div>
  <div id="map" style="display: block;"></div>
  <button id="beacon-button" style="display: none;">Beacon OFF</button>
  <div id="ui-container" style="display: none;">
    <button id="refresh-button" style="display: none;">Refresh</button>
    <div id="search-users">
      <h3>Search Users</h3>
      <input id="search-input" type="text" placeholder="Search name...">
      <button id="search-button">Search</button>
      <ul id="search-users-list"></ul>
    </div>
    <div id="nearby-users">
      <h3>Nearby (1 km)</h3>
      <ul id="nearby-users-list"></ul>
    </div>
    <div id="message-list"></div>
    <input id="message-input" type="text" placeholder="Message...">
    <button id="send-message">Send</button>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js';
    import { getFirestore, collection, doc, setDoc, onSnapshot, GeoPoint, query, orderBy, startAt, endAt, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js';
    import { getAuth, signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDC6w15EQdfuBTZHlpvoxmaL5ISEgbFAWY",
      authDomain: "risk-ec382.firebaseapp.com",
      projectId: "risk-ec382",
      storageBucket: "risk-ec382.firebasestorage.app",
      messagingSenderId: "177105151944",
      appId: "1:177105151944:web:758b928eb83ccb894902fd",
      measurementId: "G-2LKEG2N7ZD"
    };

    let app, db, auth;
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      console.log('Firebase initialized');
    } catch (error) {
      console.error('Firebase init error:', error);
      document.getElementById('loading-message').textContent = 'Error: Firebase failed.';
      document.getElementById('loading-message').style.display = 'block';
    }

    let userPosition = null;
    let userMarker = null;
    let map = null;
    let otherUsers = {};
    let beaconOn = false;
    let audioContext = null;
    let oscillator = null;
    let userId = null;
    let selectedRecipientId = null;
    let watchId = null;

    const loadingMessage = document.getElementById('loading-message');
    const locationPermissionMessage = document.getElementById('location-permission-message');
    const retryLocationButton = document.getElementById('retry-location');
    const defaultLocationButton = document.getElementById('use-default-location');
    const nameContainer = document.getElementById('name-container');
    const nameInput = document.getElementById('name-input');
    const setNameButton = document.getElementById('set-name-button');
    const beaconButton = document.getElementById('beacon-button');
    const uiContainer = document.getElementById('ui-container');
    const refreshButton = document.getElementById('refresh-button');
    const searchInput = document.getElementById('search-input');
    const searchButton = document.getElementById('search-button');
    const searchUsersList = document.getElementById('search-users-list');
    const nearbyUsersList = document.getElementById('nearby-users-list');
    const messageInput = document.getElementById('message-input');
    const sendMessageButton = document.getElementById('send-message');
    const messageList = document.getElementById('message-list');

    function logDebug(msg) {
      console.log(`${new Date().toLocaleTimeString()}: ${msg}`);
    }

    async function initMap() {
      if (typeof L === 'undefined') {
        logDebug('Leaflet not loaded');
        loadingMessage.textContent = 'Failed to load map. Check connection.';
        loadingMessage.style.display = 'block';
        return false;
      }
      try {
        map = L.map('map').setView([0, 0], 14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap'
        }).addTo(map);
        map.invalidateSize();
        window.addEventListener('resize', () => {
          map.invalidateSize();
          logDebug('Map resized');
        });
        logDebug('Map initialized');
        return true;
      } catch (error) {
        console.error('Map init error:', error);
        loadingMessage.textContent = 'Map failed to load.';
        loadingMessage.style.display = 'block';
        logDebug(`Map init error: ${error.message}`);
        return false;
      }
    }

    async function tryAuthenticate() {
      if (!auth) {
        loadingMessage.textContent = 'Firebase not initialized.';
        loadingMessage.style.display = 'block';
        logDebug('Auth failed: no auth object');
        return;
      }
      loadingMessage.textContent = 'Authenticating...';
      loadingMessage.style.display = 'block';
      logDebug('Authenticating');
      try {
        const userCredential = await signInAnonymously(auth);
        userId = userCredential.user.uid;
        logDebug(`Authenticated: ${userId}`);

        if (db) {
          try {
            const snapshot = await getDocs(collection(db, 'users'));
            const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
            await Promise.all(deletePromises);
            logDebug(`Reset ${snapshot.size} user docs`);
          } catch (error) {
            console.error('Reset error:', error);
            logDebug(`Reset error: ${error.message}`);
          }
        }

        loadingMessage.textContent = 'Loading map...';
        if (await initMap()) {
          loadingMessage.style.display = 'none';
          nameContainer.style.display = 'block';
          nameInput.value = localStorage.getItem('userName') || '';
          logDebug('Name input shown');
        } else {
          loadingMessage.textContent = 'Map failed to load.';
          loadingMessage.style.display = 'block';
        }
      } catch (error) {
        console.error('Auth error:', error);
        loadingMessage.textContent = `Auth failed: ${error.message}`;
        loadingMessage.style.display = 'block';
        logDebug(`Auth error: ${error.code} - ${error.message}`);
      }
    }

    tryAuthenticate();

    function requestLocation(attempt = 1, maxAttempts = 3) {
      if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
        logDebug('Cleared previous watch');
      }
      loadingMessage.textContent = `Getting location (attempt ${attempt}/${maxAttempts})...`;
      loadingMessage.style.display = 'block';
      locationPermissionMessage.style.display = 'none';
      logDebug(`Requesting location, attempt ${attempt}`);

      // Try getCurrentPosition first for quick response
      navigator.geolocation.getCurrentPosition(
        position => {
          userPosition = [position.coords.latitude, position.coords.longitude];
          handleLocationSuccess();
        },
        error => {
          handleLocationError(error, attempt, maxAttempts);
        },
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
      );

      // Start watchPosition for continuous updates
      watchId = navigator.geolocation.watchPosition(
        position => {
          userPosition = [position.coords.latitude, position.coords.longitude];
          handleLocationSuccess();
        },
        error => {
          handleLocationError(error, attempt, maxAttempts);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }

    function handleLocationSuccess() {
      loadingMessage.style.display = 'none';
      refreshButton.style.display = 'block';
      beaconButton.style.display = 'block';
      map.style.display = 'block';
      updateUserLocation();
      if (map && userPosition) {
        map.setView(userPosition, 15);
        map.invalidateSize();
        logDebug(`Map zoomed to: ${userPosition}, zoom 15`);
      }
      if (beaconOn) {
        fetchNearbyUsers();
      }
    }

    function handleLocationError(error, attempt, maxAttempts) {
      console.error('Location error:', error);
      logDebug(`Location error: ${error.message}, attempt ${attempt}/${maxAttempts}`);
      loadingMessage.style.display = 'none';
      locationPermissionMessage.style.display = 'block';
      if (error.code === error.PERMISSION_DENIED) {
        locationPermissionMessage.querySelector('p').textContent = 'Location access denied. Please enable in browser settings.';
      } else if (attempt < maxAttempts) {
        setTimeout(() => requestLocation(attempt + 1, maxAttempts), 2000);
      } else {
        locationPermissionMessage.querySelector('p').textContent = `Failed to get location: ${error.message}. Try again or use default.`;
      }
    }

    retryLocationButton.addEventListener('click', () => {
      logDebug('Retry location clicked');
      requestLocation();
    });

    defaultLocationButton.addEventListener('click', () => {
      logDebug('Using default location');
      userPosition = [40.7128, -74.0]; // New York City
      loadingMessage.style.display = 'none';
      locationPermissionMessage.style.display = 'none';
      handleLocationSuccess();
    });

    setNameButton.addEventListener('click', () => {
      if (nameInput.value.trim()) {
        nameContainer.style.display = 'none';
        beaconButton.style.display = 'block';
        map.style.display = 'block';
        map.invalidateSize();
        requestLocation();
        logDebug('Beacon button and map shown');
      } else {
        alert('Please enter a name.');
      }
    });

    async function updateUserLocation() {
      if (!userPosition || !userId || !db || !map) {
        logDebug('Cannot update location: missing userPosition, userId, db, or map');
        return;
      }
      const hash = geofire.geohashForLocation(userPosition);
      const name = nameInput.value.trim() || localStorage.getItem('userName') || `User_${userId.substring(0, 5)}`;
      try {
        await setDoc(doc(db, 'users', userId), {
          location: new GeoPoint(userPosition[0], userPosition[1]),
          geohash: hash,
          beaconOn: beaconOn,
          name: name,
          timestamp: new Date()
        });
        localStorage.setItem('userName', name);
        logDebug(`Updated user: ${name}, ${userPosition}`);
      } catch (error) {
        console.error('Firestore error:', error);
        logDebug(`Firestore error: ${error.message}`);
      }
      if (userMarker) {
        userMarker.setLatLng(userPosition);
      } else {
        userMarker = L.circleMarker(userPosition, {
          color: 'red',
          fillColor: 'red',
          fillOpacity: 1,
          radius: 10
        }).addTo(map);
        userMarker._path.classList.add('flashing');
        logDebug(`Added flashing user marker: ${userPosition}`);
      }
    }

    beaconButton.addEventListener('click', () => {
      beaconOn = !beaconOn;
      beaconButton.textContent = `Beacon ${beaconOn ? 'ON' : 'OFF'}`;
      beaconButton.style.background = beaconOn ? '#d32f2f' : '#1976d2';
      logDebug(`Beacon: ${beaconOn}`);
      if (beaconOn) {
        requestLocation();
        startBeep();
        uiContainer.style.display = 'block';
        refreshButton.style.display = 'block';
        logDebug('UI container shown');
      } else {
        stopBeep();
        uiContainer.style.display = 'none';
        refreshButton.style.display = 'none';
        messageList.innerHTML = '';
        if (watchId) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
          logDebug('Stopped location watch');
        }
        logDebug('UI container hidden');
      }
      updateUserLocation();
    });

    refreshButton.addEventListener('click', () => {
      Object.values(otherUsers).forEach(user => {
        if (user.marker) map.removeLayer(user.marker);
      });
      otherUsers = {};
      fetchNearbyUsers();
      logDebug('Markers refreshed');
    });

    async function fetchNearbyUsers() {
      if (!userPosition || !beaconOn || !db) {
        logDebug('Cannot fetch nearby users: missing userPosition, beaconOn, or db');
        return;
      }
      const radiusInM = 1000;
      const bounds = geofire.geohashQueryBounds(userPosition, radiusInM);
      const promises = [];
      for (const b of bounds) {
        const q = query(collection(db, 'users'), orderBy('geohash'), startAt(b[0]), endAt(b[1]));
        promises.push(getDocs(q));
      }
      try {
        const snapshots = await Promise.all(promises);
        nearbyUsersList.innerHTML = '';
        const nearbyUsers = [];
        for (const snap of snapshots) {
          for (const doc of snap.docs) {
            const data = doc.data();
            if (data.beaconOn && data.location && doc.id !== userId) {
              const distance = geofire.distanceBetween([data.location.latitude, data.location.longitude], userPosition) * 1000;
              if (distance <= radiusInM) {
                nearbyUsers.push({ id: doc.id, name: data.name, distance });
              }
            }
          }
        }
        nearbyUsers.forEach(user => {
          const li = document.createElement('li');
          li.textContent = `${user.name} (${Math.round(user.distance)}m)`;
          const msgButton = document.createElement('button');
          msgButton.textContent = 'Msg';
          msgButton.onclick = () => {
            selectedRecipientId = user.id;
            messageList.innerHTML = `<h3>Messages with ${user.name}</h3>`;
            listenForMessages();
          };
          li.appendChild(msgButton);
          nearbyUsersList.appendChild(li);
        });
        logDebug(`Fetched ${nearbyUsers.length} nearby users`);
      } catch (error) {
        console.error('Fetch nearby error: ${error}`);
        logDebug(`Fetch nearby error: ${error.message}`);
      }
    }

    searchButton.addEventListener('click', () => {
      const searchTerm = searchInput.value.trim();
      if (!searchTerm || !db) {
        log('Cannot search: missing term or db');
        return;
      }
      const q = query(collection(db, 'users'), orderBy('name'), startAt(searchTerm), endAt(searchTerm + '\uf8ff'));
      try {
        const results = await snapshot.getDocs(q);
        searchUsersList.innerHTML = '';
        results.forEach(doc => {
          const data = doc.data();
          if (data.beaconOn && doc.id !== userId) {
            const li = document.createElement('li');
            li.textContent = data.name;
            const msgButton = document.createElement('button');
            msgButton.textContent = 'Msg';
            msgButton.onclick = () => {
              selectedRecipientId = doc.id;
              messageList.innerHTML = `<h3>Messages with ${data.name}</h3>`;
              listenForMessages();
            };
            li.appendChild(msgButton);
            searchUsersList.appendChild(li);
          }
        });
        logDebug(`Searched users: ${searchTerm}`);
      } catch (error) {
        console.error('Search error:', error);
        logDebug(`Search error: ${error.message}`);
      }
    });

    sendMessageButton.addEventListener('click', async () => {
      if (selectedRecipientId && messageInput.value.trim() && db) {
        const message = {
          senderId: userId,
          recipientId: selectedRecipientId,
          content: messageInput.value.trim(),
          timestamp: new Date()
        };
        try {
          await setDoc(doc(collection(db, 'users', selectedRecipientId, 'messages')), message);
          await setDoc(doc(collection(db, 'users', userId, 'messages')), message);
          messageInput.value = '';
          logDebug('Message sent');
        } catch (error) {
          console.error('Send message error:', error);
          logDebug(`Send message error: ${error.message}`);
        }
      }
    });

    function listenForMessages() {
      if (!selectedRecipientId || !db) {
        logDebug('Cannot listen for messages: missing recipient or db');
        return;
      }
      try {
        onSnapshot(collection(db, 'users', userId, 'messages'), snapshot => {
          if (!messageList.innerHTML) return;
          messageList.innerHTML = `<h3>Messages with ${selectedRecipientId.substring(0, 5)}</h3>`;
          snapshot.forEach(doc => {
            const msg = doc.data();
            if (msg.senderId === selectedRecipientId || msg.recipientId === selectedRecipientId) {
              const p = document.createElement('p');
              p.textContent = `${msg.senderId === userId ? 'You' : 'They'}: ${msg.content}`;
              messageList.appendChild(p);
            }
          });
          messageList.scrollTop = messageList.scrollHeight;
        }, error => {
          console.error('Messages error:', error);
          logDebug(`Messages error: ${error.message}`);
        });
      } catch (error) {
        console.error('Snapshot error:', error);
        logDebug(`Snapshot error: ${error.message}`);
      }
    }

    function startBeep() {
      if (!audioContext) {
        try {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          if (audioContext.state === 'suspended') {
            audioContext.resume().catch(err => logDebug(`Audio resume error: ${err}`));
          }
        } catch (error) {
          console.error('Audio init error:', error);
          logDebug(`Audio init error: ${error.message}`);
          return;
        }
      }
      updateBeep();
    }

    function stopBeep() {
      if (oscillator) {
        oscillator.stop();
        oscillator = null;
      }
      logDebug('Beep stopped');
    }

    function updateBeep() {
      if (!beaconOn || !audioContext || audioContext.state !== 'running') {
        stopBeep();
        return;
      }
      const activeUsers = Object.values(otherUsers).filter(user => user.beaconOn && user.location);
      if (activeUsers.length === 0) {
        stopBeep();
        return;
      }
      let minDistance = Infinity;
      activeUsers.forEach(user => {
        const distance = map.distance(userPosition, [user.location.latitude, user.location.longitude]);
        if (distance < minDistance) minDistance = distance;
      });
      const maxDistance = 1000;
      const minFrequency = 0.5;
      const maxFrequency = 5;
      let frequency = minDistance < maxDistance
        ? minFrequency + (maxFrequency - minFrequency) * (1 - minDistance / maxDistance)
        : 0;
      if (frequency > 0) {
        try {
          if (!oscillator) {
            oscillator = audioContext.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            oscillator.connect(audioContext.destination);
            oscillator.start();
          }
          oscillator.frequency.setValueAtTime(440 * frequency, audioContext.currentTime + 0.1);
          logDebug(`Beep started, frequency: ${frequency}`);
          setTimeout(updateBeep, 1000 / frequency);
        } catch (error) {
          console.error('Beep error:', error);
          logDebug(`Beep error: ${error.message}`);
          stopBeep();
        }
      } else {
        stopBeep();
      }
    }

    if (db) {
      try {
        onSnapshot(collection(db, 'users'), async snapshot => {
          Object.values(otherUsers).forEach(user => {
            if (user.marker) map.removeLayer(user.marker);
          });
          otherUsers = {};
          snapshot.forEach(doc => {
            const data = doc.data();
            const id = doc.id;
            if (id === userId) return;
            if (data.beaconOn && data.location && data.timestamp) {
              const lastUpdate = data.timestamp.toDate();
              const now = new Date();
              const age = (now - lastUpdate) / 1000 / 60;
              if (age < 5) {
                const latlng = [data.location.latitude, data.location.longitude];
                otherUsers[id] = {
                  marker: L.circleMarker(latlng, { color: 'blue', fillColor: 'blue', fillOpacity: 0.8, radius: 6 }).addTo(map),
                  location: data.location,
                  beaconOn: true
                };
              } else {
                deleteDoc(doc.ref).catch(err => logDebug(`Delete doc: ${err}`));
              }
            }
          });
          logDebug(`Other users: ${Object.keys(otherUsers).length}`);
          if (beaconOn) {
            updateBeep();
            fetchNearbyUsers();
          }
        }, error => {
          console.error('Users snapshot error:', error);
          logDebug(`Users snapshot error: ${error.message}`);
        });
      } catch (error) {
        console.error('Snapshot setup error:', error);
        logDebug(`Snapshot setup error: ${error.message}`);
      }
    }
  </script>
</body>
</html>