<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Map Application</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha512-Zcn6bjR/8n/hu2O+WVhaK4xF5Qr3jsP4d99+2DM0W9GIt6s6v4Vo4RY+0yNagZx0cMim3rj4o01vD0iQ5vD/9+A==" crossorigin="" />
  <!-- Vue.js CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    /* Map container styling to fix partial display */
    #map {
      height: 400px;
      width: 100%;
      border: 1px solid #ccc;
    }
    .map-container {
      position: relative;
      height: 400px;
      width: 100%;
      margin-bottom: 20px;
    }
    /* Center error messages and buttons */
    .error-message, .retry-button {
      text-align: center;
      margin: 10px 0;
    }
    .error-message p {
      color: #d32f2f;
      font-weight: bold;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background-color: #0056b3;
    }
    /* Status and nearby users styling */
    .status-container, .nearby-users {
      margin-top: 20px;
    }
    .status-container p {
      margin: 5px 0;
    }
    .nearby-users h3 {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Initializing state -->
    <div v-if="initializing">
      <p>Initializing application...</p>
    </div>

    <!-- Authentication Error -->
    <div v-if="authError" class="error-message">
      <p>Authentication Error</p>
      <p>Unable to authenticate. Please try again.</p>
      <button class="retry-button" @click="retryAuth">Retry</button>
    </div>

    <!-- Map Section -->
    <div v-if="mapError" class="error-message">
      <p>Map Error</p>
      <p>Failed to load map. Please check your connection.</p>
      <button class="retry-button" @click="retryMap">Retry</button>
    </div>
    <div v-else class="map-container">
      <div id="map"></div>
    </div>

    <!-- Location Permissions -->
    <div v-if="locationError" class="error-message">
      <p>Location Required</p>
      <p>Please enable location permissions to use this app.</p>
      <button class="retry-button" @click="retryLocation">Retry</button>
    </div>

    <!-- User Status Section -->
    <div class="status-container">
      <div>
        <p>Status: <span>{{ status }}</span></p>
        <p>User: <span>{{ user }}</span></p>
      </div>
      <div>
        <button @click="goOnline">{{ status === 'ONLINE' ? 'Go Offline' : 'Go Online' }}</button>
        <button @click="setName">Set Name</button>
      </div>
      <button @click="refreshLocation">Refresh Location</button>
    </div>

    <!-- Nearby Users -->
    <div class="nearby-users">
      <h3>Nearby Users (1km)</h3>
      <p v-if="loadingNearby">Loading nearby users...</p>
      <ul v-else>
        <li v-for="nearbyUser in nearbyUsers" :key="nearbyUser.id">
          {{ nearbyUser.name }} ({{ nearbyUser.distance }}m)
        </li>
      </ul>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha512-BwHfrr4cWJ8Ek4HZrV2k+pX9S0Q71+hi5k6E9MHv6+3tJweU1v+/bK5gwhSI3kJ3YAsr2kJ2lQQ4odQ2hWjDL2Q==" crossorigin=""></script>
  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          initializing: true,
          authError: false,
          mapError: false,
          locationError: false,
          status: 'OFFLINE',
          user: 'loading...',
          map: null,
          userLocation: null,
          loadingNearby: true,
          nearbyUsers: [],
        };
      },
      mounted() {
        this.initializeApp();
      },
      methods: {
        async initializeApp() {
          // Simulate app initialization
          setTimeout(() => {
            this.initializing = false;
            this.user = 'Anonymous';
            this.initMap();
            this.getUserLocation();
            this.loadNearbyUsers();
          }, 1000);
        },
        initMap() {
          try {
            // Initialize Leaflet map
            this.map = L.map('map').setView([51.505, -0.09], 13); // Default: London
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
              maxZoom: 19,
            }).addTo(this.map);
            this.mapError = false;
          } catch (error) {
            console.error('Map initialization failed:', error);
            this.mapError = true;
          }
        },
        getUserLocation() {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                const { latitude, longitude } = position.coords;
                this.userLocation = [latitude, longitude];
                this.locationError = false;
                // Center map on user location
                if (this.map) {
                  this.map.setView(this.userLocation, 15);
                  L.marker(this.userLocation)
                    .addTo(this.map)
                    .bindPopup('You are here')
                    .openPopup();
                }
              },
              (error) => {
                console.error('Geolocation error:', error);
                this.locationError = true;
              }
            );
          } else {
            this.locationError = true;
          }
        },
        retryAuth() {
          // Simulate authentication retry
          this.authError = false;
          this.initializeApp();
        },
        retryMap() {
          this.mapError = false;
          this.initMap();
        },
        retryLocation() {
          this.locationError = false;
          this.getUserLocation();
        },
        goOnline() {
          this.status = this.status === 'ONLINE' ? 'OFFLINE' : 'ONLINE';
        },
        setName() {
          const newName = prompt('Enter your name:') || 'Anonymous';
          this.user = newName;
        },
        refreshLocation() {
          this.getUserLocation();
        },
        async loadNearbyUsers() {
          // Simulate loading nearby users
          this.loadingNearby = true;
          setTimeout(() => {
            this.nearbyUsers = [
              { id: 1, name: 'User1', distance: 500 },
              { id: 2, name: 'User2', distance: 750 },
            ];
            this.loadingNearby = false;
          }, 1000);
        },
      },
    }).mount('#app');
  </script>
</body>
</html>