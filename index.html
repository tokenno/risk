<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live User Map</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin=""/>
  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, off, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDC6w15EQdfuBTZHlpvoxmaL5ISEgbFAWY",
      authDomain: "risk-ec382.firebaseapp.com",
      databaseURL: "https://risk-ec382-default-rtdb.firebaseio.com",
      projectId: "risk-ec382",
      storageBucket: "risk-ec382.appspot.com",
      messagingSenderId: "177105151944",
      appId: "1:177105151944:web:758b928eb83ccb894902fd",
      measurementId: "G-2LKEG2N7ZD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Make available globally
    window.firebase = {
      db,
      ref,
      set,
      onValue,
      off,
      push,
      auth,
      signInAnonymously
    };
  </script>
  <style>
    /* ... (keep your existing styles) ... */
  </style>
</head>
<body>
  <div id="app">
    <!-- ... (keep your existing HTML structure) ... -->
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          status: 'OFFLINE',
          user: 'Anonymous',
          userLocation: null,
          map: null,
          nearbyUsers: [],
          loadingNearby: true,
          currentUserId: null,
          userMarkers: {}
        };
      },
      async mounted() {
        await this.initializeFirebase();
        this.initMap();
        this.startLocationTracking();
      },
      methods: {
        async initializeFirebase() {
          try {
            const userCredential = await firebase.signInAnonymously(firebase.auth);
            this.currentUserId = userCredential.user.uid;
            console.log("Connected as user:", this.currentUserId);
          } catch (error) {
            console.error("Firebase auth error:", error);
          }
        },

        initMap() {
          this.map = L.map('map').setView([51.505, -0.09], 13);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
          }).addTo(this.map);
        },

        startLocationTracking() {
          if (!navigator.geolocation) {
            console.error("Geolocation not supported");
            return;
          }

          navigator.geolocation.watchPosition(
            position => {
              const { latitude, longitude } = position.coords;
              this.userLocation = [latitude, longitude];
              
              if (this.status === 'ONLINE') {
                this.updateUserLocation();
              }

              if (this.map) {
                this.map.setView(this.userLocation, 15);
                if (!this.userMarker) {
                  this.userMarker = L.marker(this.userLocation)
                    .addTo(this.map)
                    .bindPopup("You are here")
                    .openPopup();
                } else {
                  this.userMarker.setLatLng(this.userLocation);
                }
              }
            },
            error => {
              console.error("Geolocation error:", error);
            },
            { enableHighAccuracy: true }
          );
        },

        updateUserLocation() {
          if (!this.firebase || !this.currentUserId || !this.userLocation) return;
          
          firebase.set(firebase.ref(firebase.db, `users/${this.currentUserId}`), {
            lat: this.userLocation[0],
            lng: this.userLocation[1],
            name: this.user,
            lastOnline: Date.now()
          });
        },

        listenForNearbyUsers() {
          const usersRef = firebase.ref(firebase.db, 'users');
          
          firebase.onValue(usersRef, (snapshot) => {
            const allUsers = snapshot.val() || {};
            this.processNearbyUsers(allUsers);
          });
        },

        processNearbyUsers(allUsers) {
          this.clearUserMarkers();
          
          this.nearbyUsers = Object.entries(allUsers)
            .filter(([id]) => id !== this.currentUserId)
            .map(([id, user]) => {
              const distance = this.calculateDistance(
                this.userLocation,
                [user.lat, user.lng]
              );
              
              this.updateUserMarker(id, user, distance);
              
              return {
                id,
                name: user.name || 'Anonymous',
                distance: Math.round(distance),
                position: [user.lat, user.lng]
              };
            })
            .filter(user => user.distance < 1000) // Within 1km
            .sort((a, b) => a.distance - b.distance);
            
          this.loadingNearby = false;
        },

        updateUserMarker(userId, user, distance) {
          if (!this.userMarkers[userId]) {
            this.userMarkers[userId] = L.marker([user.lat, user.lng])
              .addTo(this.map)
              .bindPopup(`${user.name || 'User'} (${distance}m)`);
          } else {
            this.userMarkers[userId].setLatLng([user.lat, user.lng]);
            this.userMarkers[userId].setPopupContent(`${user.name || 'User'} (${distance}m)`);
          }
        },

        clearUserMarkers() {
          Object.values(this.userMarkers).forEach(marker => marker.remove());
          this.userMarkers = {};
        },

        calculateDistance(pos1, pos2) {
          const [lat1, lon1] = pos1;
          const [lat2, lon2] = pos2;
          const R = 6371e3; // Earth radius in meters
          const φ1 = lat1 * Math.PI/180;
          const φ2 = lat2 * Math.PI/180;
          const Δφ = (lat2-lat1) * Math.PI/180;
          const Δλ = (lon2-lon1) * Math.PI/180;

          const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                   Math.cos(φ1) * Math.cos(φ2) *
                   Math.sin(Δλ/2) * Math.sin(Δλ/2);
          const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

          return R * c;
        },

        goOnline() {
          this.status = 'ONLINE';
          this.updateUserLocation();
          this.listenForNearbyUsers();
          
          // Add test users when in development
          if (window.location.hostname === 'localhost') {
            this.addTestUsers();
          }
        },

        goOffline() {
          this.status = 'OFFLINE';
          firebase.set(firebase.ref(firebase.db, `users/${this.currentUserId}`), null);
          firebase.off(firebase.ref(firebase.db, 'users'));
          this.clearUserMarkers();
        },

        addTestUsers() {
          // Test user 1 (500m northeast)
          firebase.set(firebase.ref(firebase.db, 'users/test_user1'), {
            lat: this.userLocation[0] + 0.0045,
            lng: this.userLocation[1] + 0.0045,
            name: "Test User 1",
            lastOnline: Date.now()
          });
          
          // Test user 2 (750m southwest)
          firebase.set(firebase.ref(firebase.db, 'users/test_user2'), {
            lat: this.userLocation[0] - 0.0067,
            lng: this.userLocation[1] - 0.0067,
            name: "Test User 2",
            lastOnline: Date.now()
          });
        },

        setName() {
          const newName = prompt('Enter your name:', this.user);
          if (newName !== null) {
            this.user = newName || 'Anonymous';
            if (this.status === 'ONLINE') {
              this.updateUserLocation();
            }
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>